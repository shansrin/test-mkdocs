<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>User Guide - Coherence Operator</title>
    <link href="../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/bootstrap-3.3.7.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "User Guide", url: "#_top", children: [
          ]},
          {title: "Guide to this Document", url: "#guide-to-this-document", children: [
          ]},
          {title: "Before You Begin", url: "#before-you-begin", children: [
          ]},
          {title: "Common Coherence Tasks", url: "#common-coherence-tasks", children: [
              {title: "Provide Configuration Files and Application Classes to the Coherence Cluster within Kubernetes", url: "#provide-configuration-files-and-application-classes-to-the-coherence-cluster-within-kubernetes" },
              {title: "Deploy JAR Containing Application Classes and Configuration files", url: "#deploy-jar-containing-application-classes-and-configuration-files" },
              {title: "Extract Heap Dump Files from a Kubernetes Coherence Pod", url: "#extract-heap-dump-files-from-a-kubernetes-coherence-pod" },
              {title: "Extract Coherence Log Files from Kubernetes", url: "#extract-coherence-log-files-from-kubernetes" },
              {title: "Use Java Management Extensions (JMX) to Inspect and Manage Coherence", url: "#use-java-management-extensions-jmx-to-inspect-and-manage-coherence" },
              {title: "Provide Arguments to the JVM that Runs Coherence", url: "#provide-arguments-to-the-jvm-that-runs-coherence" },
          ]},
          {title: "Kubernetes Specific Tasks", url: "#kubernetes-specific-tasks", children: [
              {title: "Using Helm to Scale the Coherence Deployment", url: "#using-helm-to-scale-the-coherence-deployment" },
              {title: "Perform a Safe Rolling Upgrade", url: "#perform-a-safe-rolling-upgrade" },
              {title: "Deploy Multiple Coherence Clusters", url: "#deploy-multiple-coherence-clusters" },
          ]},
          {title: "Monitoring Performance and Logging", url: "#monitoring-performance-and-logging", children: [
              {title: "Configuring SSL Endpoints for Management over REST and Metrics Publishing", url: "#configuring-ssl-endpoints-for-management-over-rest-and-metrics-publishing" },
              {title: "Configuring SSL Endpoints for Management over REST", url: "#configuring-ssl-endpoints-for-management-over-rest" },
              {title: "Configuring SSL for Metrics Publishing for Prometheus", url: "#configuring-ssl-for-metrics-publishing-for-prometheus" },
          ]},
        ];

    </script>
    <script src="../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../samples/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../samples/" class="btn btn-xs btn-link">
        Samples
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../quickstart/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../quickstart/" class="btn btn-xs btn-link">
        Quick Start
      </a>
    </div>
    
  </div>

    

    <h1 id="user-guide">User Guide</h1>
<p>The User Guide provides detailed information about how to install
Coherence and the Coherence Operator in your Kubernetes cluster, and how to use the operator to manage Coherence clusters.</p>
<ul>
<li><a href="#guide-to-this-document">Guide to this Document</a></li>
<li><a href="#before-you-begin">Before You Begin</a></li>
<li><a href="#common-coherence-tasks">Common Coherence Tasks</a></li>
<li><a href="#provide-configuration-files-and-application-classes-to-the-coherence-cluster-within-kubernetes">Provide Configuration Files and Application Classes to the Coherence Cluster within Kubernetes</a><ul>
<li><a href="#deploy-jar-files">Deploy JAR Files</a></li>
<li><a href="#create-a-jar-file">Create a JAR File</a></li>
<li><a href="#create-a-docker-image-for-the-sidecar">Create a Docker image for the Sidecar</a></li>
<li><a href="#use-helm-to-install-coherence">Use Helm to Install Coherence</a></li>
<li><a href="#create-the-local-extend-client-configuration">Create the Local Extend Client Configuration</a></li>
<li><a href="#remove-coherence">Remove Coherence</a></li>
<li><a href="#deploy-configuration-files">Deploy Configuration Files</a></li>
<li><a href="#create-the-server-side-cache-configuration">Create the Server Side Cache Configuration</a></li>
<li><a href="#create-a-docker-image-for-the-sidecar">Create a Docker Image for the Sidecar</a></li>
<li><a href="#run-the-client-program">Run the client program</a></li>
</ul>
</li>
<li><a href="#deploy-jar-containing-application-classes-and-configuration-files">Deploy JAR Containing Application Classes and Configuration files</a></li>
<li><a href="#extract-heap-dump-files-from-a-kubernetes-coherence-pod">Extract Heap Dump Files from a Kubernetes Coherence Pod</a></li>
<li><a href="#extract-coherence-log-files-from-kubernetes">Extract Coherence Log Files from Kubernetes</a><ul>
<li><a href="#query-elasticsearch">Query Elasticsearch</a></li>
</ul>
</li>
<li><a href="#use-java-management-extensions--jmx--to-inspect-and-manage-coherence">Use Java Management Extensions (JMX) to Inspect and Manage Coherence</a><ul>
<li><a href="#download-the--opendmk-jmxremote-optional-jar--jar">Download the <code>opendmk_jmxremote_optional_jar</code> JAR</a></li>
<li><a href="#run-visualvm-with-the-additional-jar">Run VisualVM with the Additional JAR</a></li>
<li><a href="#manipulate-the-visualvm-ui-to-view-the-coherence-mbeans">Manipulate the VisualVM UI to View the Coherence MBeans</a></li>
</ul>
</li>
<li><a href="#provide-arguments-to-the-jvm-that-runs-coherence">Provide Arguments to the JVM that Runs Coherence</a></li>
<li><a href="#kubernetes-specific-tasks">Kubernetes Specific Tasks</a></li>
<li><a href="#using-helm-to-scale-the-coherence-deployment">Using Helm to Scale the Coherence Deployment</a></li>
<li><a href="#perform-a-safe-rolling-upgrade">Perform a Safe Rolling Upgrade</a></li>
<li><a href="#deploy-multiple-coherence-clusters">Deploy Multiple Coherence Clusters</a></li>
<li><a href="#monitoring-performance-and-logging">Monitoring Performance and Logging</a></li>
<li><a href="#configuring-ssl-endpoints-for-management-over-rest-and-metrics-publishing">Configuring SSL Endpoints for Management over REST and Metrics Publishing</a></li>
<li><a href="#configuring-ssl-endpoints-for-management-over-rest">Configuring SSL Endpoints for Management over REST</a></li>
<li><a href="#configuring-ssl-for-metrics-publishing-for-prometheus">Configuring SSL for Metrics Publishing for Prometheus</a></li>
</ul>
<h1 id="guide-to-this-document">Guide to this Document</h1>
<p>The User Guide provides exclusive steps for managing Coherence within Kubernetes. For most of the administrative tasks for managing Kubernetes, refer to <a href="https://kubernetes.io/docs/home/">Kubernetes</a> Documentation.</p>
<p>The information in this guide is organized into sections that are common and Kubernetes specific tasks. Refer to these sections for managing Coherence:
* <a href="#common-coherence-tasks">Common Coherence Tasks</a>
* <a href="#kubernetes-specific-tasks">Kubernetes Specific Tasks</a></p>
<h1 id="before-you-begin">Before You Begin</h1>
<p>Refere to <a href="../quickstart/#before-you-begin">Before You Begin</a> section in the Quick Start guide.</p>
<p>All the examples in this guide are installed in a Kubernetes namespace called <em>sample-coherence-ns</em>.  To set this namespace as the active namespace, execute the command:</p>
<pre><code class="bash">$ kubectl config set-context $(kubectl config current-context) --namespace=sample-coherence-ns
</code></pre>

<h1 id="common-coherence-tasks">Common Coherence Tasks</h1>
<p>The most common administrative tasks with Coherence are <a href="https://docs.oracle.com/middleware/12213/coherence/develop-applications/understanding-configuration.htm#COHDG-GUID-C5335E66-6D7F-4C15-B7EC-F6D7D1494066">Overriding the Default Cache Configuration
File</a>
and deploying JARs for <a href="https://docs.oracle.com/middleware/12213/coherence/develop-applications/processing-data-cache.htm">Processing Data in a
Cache</a>.</p>
<p>Most of the administrative tasks to do with Coherence apply when running within Kubernetes.  The <a href="https://docs.oracle.com/middleware/12213/coherence/">Oracle Coherence</a> documentation remains a very useful resource. This section covers a few common scenarios that require special treatment regarding Kubernetes.</p>
<h2 id="provide-configuration-files-and-application-classes-to-the-coherence-cluster-within-kubernetes">Provide Configuration Files and Application Classes to the Coherence Cluster within Kubernetes</h2>
<p>This section explains how to make custom configuration and JAR files
available to your Coherence cluster running in Kubernetes. This approach can be used for any administrative tasks that require to make JAR, XML, or other configuration files available to the Coherence cluster.</p>
<p>You can refer to <a href="samples/coherence-deployments/sidecar#add-application-jarsconfig-to-a-coherence-deployment">Add Application Jars/Config to a Coherence Deployment</a> in the Samples.</p>
<p>The Coherence Operator uses the <em>sidecar pattern</em>, as
recommended by <a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/#sidecar-container-with-a-logging-agent">Kubernetes</a>,
to make resources available to Coherence within the Kubernetes cluster.
Docker containers are the most flexible way to allow interaction
with the Coherence cluster running in Kubernetes. The steps to use the sidecar pattern include:</p>
<ol>
<li>
<p>Determine the JARs or configuration files that you want to make them available to the cluster.</p>
</li>
<li>
<p>Package the files in a Docker image and deploy that image to a
  Docker registry accessible to the Kubernetes cluster.</p>
</li>
<li>
<p>Install the docker image using the Helm chart.</p>
</li>
</ol>
<h3 id="deploy-jar-files">Deploy JAR Files</h3>
<p>The concept to create a JAR file is derived from <a href="https://docs.oracle.com/middleware/12213/coherence/develop-remote-clients/building-your-first-extend-application.htm">Building Your First Extend Application</a> in
<em>Oracle Fusion Middleware Developing Remote Clients for Oracle
Coherence</em> for use within Kubernetes.</p>
<h4 id="create-a-jar-file">Create a JAR File</h4>
<p>To create a JAR file:</p>
<ol>
<li>Create a directory for the files:</li>
</ol>
<p><code>bash
  $ mkdir -p hello-example/files/lib
  $ cd hello-example</code></p>
<ol>
<li>Create a Java program to access the cluster. Save the java file as <code>HelloExample.java</code> in the <code>hello-example</code> directory.</li>
</ol>
<p>```java
  import java.io.Serializable;
  import java.text.SimpleDateFormat;
  import java.util.Date;</p>
<p>import com.tangosol.net.NamedCache;
  import com.tangosol.net.CacheFactory;  </p>
<p>public class HelloExample {
  public static void main(String[] asArgs) throws Throwable {
    NamedCache<String, Timestamp> cache = CacheFactory.getCache("hello-example");
    Timestamp ts = cache.get("ts1");
    cache.put("ts1",
              ts = new Timestamp((null == ts) ? Long.MIN_VALUE : ts.currentTime));</p>
<pre><code>System.out.println("The value of the key is " + ts.toString());
</code></pre>
<p>}</p>
<p>public static class Timestamp implements Serializable {
    public long currentTime;
    public long previousTime;</p>
<pre><code>public Timestamp(long previousTime) {
  this.currentTime = System.currentTimeMillis();
  this.previousTime = previousTime;
}

public String toString() {
  SimpleDateFormat f = new SimpleDateFormat("HH:mm:ss");
  return "Timestamp: previousTime: " + f.format(new Date(previousTime)) +
         " currentTime: " + f.format(new Date(currentTime));
}
</code></pre>
<p>}
}</p>
<pre><code>
This program uses a static inner class, `Timestamp`, to store the values in Coherence. Any Java object that is stored in Coherence must be accessible by Coherence in compiled form. The Java objects are compiled classes in JAR files on the Coherence classpath. Therefore, compile and archive the file:

  ```
  $ javac -cp .:${COHERENCE_HOME}/lib/coherence.jar HelloExample.java
  $ jar -cf files/lib/hello-example.jar *.class
  ```
#### Create a Docker image for the Sidecar

Package the created JAR file within the sidecar Docker image:

1. Create a `Dockerfile` with the following contents:

    ```bash
    FROM oraclelinux:7-slim
    RUN mkdir -p /files/lib
    COPY files/lib/hello-example.jar files/lib
    ```
    Note that the JAR file is placed in the `files/lib` directory relative to the root of the Docker image. This is the default location where Coherence looks for JAR files to add to the classpath. Any JAR files in `files/lib` are added to the classpath. You can change the location where Coherence must look for JARs to add to the classpath.

2. Ensure that the Docker is running on the current host. If not, refer to [ Get Started](https://docs.docker.com/get-started/) in Docker documentation.

3. Build and tag a Docker image for `hello-example-sidecar`:

    ```bash
    $ docker build -t &quot;hello-example-sidecar:1.0.0-SNAPSHOT&quot; .
    ```

    The trailing dot &quot;.&quot; in the command refers to run the build relative to the current directory.
4. Push the created Docker image to the Docker registry which the Kubernetes cluster can access.

   The [Quick Start](quickstart.md#obtain-images-from-oracle-container-registry) guide describes how to make the Kubernetes cluster can pull the images using the Docker credentials.

   &gt; **Note:** If you are using a local Kubernetes, you can omit this step, since the Kubernetes pulls from the same Docker server as the one to which the local build command built the image.

#### Use Helm to Install Coherence

Install Coherence using the Helm chart with the details of the sidecar image arguments:

```bash
$ helm --debug install coherence/coherence --name hello-example \
     --set userArtifacts.image=hello-example-sidecar:1.0.0-SNAPSHOT \
     --set imagePullSecrets=sample-coherence-secret
</code></pre>

<blockquote>
<p><strong>Note:</strong> If the JAR files are in a different location within the sidecar Docker image, use the <code>--set userArtifacts.libDir=&lt;absolute path within docker image&gt;</code> argument to <code>helm install</code> to configure the correct location.</p>
</blockquote>
<p>In a new terminal window, set up a Kubernetes port forward to expose the Extend port so that your local client can use it:</p>
<pre><code class="bash">$ export POD_NAME=$(kubectl get pods --namespace default -l \
   &quot;app=coherence,release=hello-example&quot; -o jsonpath=&quot;{.items[0].metadata.name}&quot;)
$ kubectl --namespace default port-forward $POD_NAME 20000:20000
</code></pre>

<p>This prints the following output and blocks the shell:</p>
<pre><code class="console">Forwarding from 127.0.0.1:20000 -&gt; 20000
Forwarding from [::1]:20000 -&gt; 20000
</code></pre>

<h4 id="create-the-local-extend-client-configuration">Create the Local Extend Client Configuration</h4>
<p>A local client configuration is necessary because the local client connects to the service through Coherence*Extend. Create a file named <code>hello-client-config.xml</code> with the following contents:</p>
<pre><code>&lt;cache-config xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
   xmlns=&quot;http://xmlns.oracle.com/coherence/coherence-cache-config&quot;
   xsi:schemaLocation=&quot;http://xmlns.oracle.com/coherence/coherence-cache-config
   coherence-cache-config.xsd&quot;&gt;
   &lt;caching-scheme-mapping&gt;
      &lt;cache-mapping&gt;
         &lt;cache-name&gt;*&lt;/cache-name&gt;
         &lt;scheme-name&gt;thin-remote&lt;/scheme-name&gt;
      &lt;/cache-mapping&gt;
   &lt;/caching-scheme-mapping&gt;

   &lt;caching-schemes&gt;
       &lt;remote-cache-scheme&gt;
           &lt;scheme-name&gt;thin-remote&lt;/scheme-name&gt;
           &lt;service-name&gt;Proxy&lt;/service-name&gt;
           &lt;initiator-config&gt;
               &lt;tcp-initiator&gt;
                  &lt;remote-addresses&gt;
                      &lt;socket-address&gt;
                          &lt;address&gt;127.0.0.1&lt;/address&gt;
                          &lt;port&gt;20000&lt;/port&gt;
                      &lt;/socket-address&gt;
                  &lt;/remote-addresses&gt;
               &lt;/tcp-initiator&gt;
           &lt;/initiator-config&gt;
       &lt;/remote-cache-scheme&gt;
   &lt;/caching-schemes&gt;
&lt;/cache-config&gt;
</code></pre>

<p>Run the client using the following command:</p>
<pre><code class="bash">$ java -cp files/lib/hello-example.jar:${COHERENCE_HOME}/lib/coherence.jar \
       -Dcoherence.log.level=1 -Dcoherence.distributed.localstorage=false \
       -Dcoherence.cacheconfig=$PWD/hello-client-config.xml HelloExample
</code></pre>

<p>An output similar to the following is displayed:</p>
<pre><code>The value of the key is Timestamp: previousTime: 11:47:04 currentTime: 16:09:30
</code></pre>

<p>Run the command again and it shows the updated <code>Timestamp</code>:</p>
<pre><code>The value of the key is Timestamp: previousTime: 16:09:30 currentTime: 16:10:20
</code></pre>

<h4 id="remove-coherence">Remove Coherence</h4>
<pre><code>$ helm delete --purge hello-example
</code></pre>

<h3 id="deploy-configuration-files">Deploy Configuration Files</h3>
<p>The similar sidecar approach is used to deploy configuration files to Coherence inside Kubernetes. Though, Coherence has the necessary built-in configuration, a subset of that configuration is used in this example.</p>
<ol>
<li>Create a directory for the files:</li>
</ol>
<p><code>bash
  $ cd ..
  $ mkdir -p hello-config-example/files/conf
  $ cd hello-config-example</code>
2. Create the Java program to access the cluster. In the same directory, create a simple java program <code>HelloConfigXml.java</code>:</p>
<p>```java
  import com.tangosol.net.CacheFactory;
  import com.tangosol.net.NamedCache;</p>
<p>public class HelloConfigXml {
    public static void main(String[] asArgs) throws Throwable {
    NamedCache<String, Integer> cache = CacheFactory.getCache("hello-config-xml");
    Integer IValue = (Integer) cache.get("key");
    IValue = (null == IValue) ? Integer.valueOf(1) : Integer.valueOf(IValue + 1);
    cache.put("key", IValue);
    System.out.println("The value of the key is " + IValue);
  }
}
  <code>``
3. Create the following XML file, next to the java file, called</code>hello-client-config.xml`:</p>
<p>```
  <cache-config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns="http://xmlns.oracle.com/coherence/coherence-cache-config"
   xsi:schemaLocation="http://xmlns.oracle.com/coherence/coherence-cache-config
   coherence-cache-config.xsd">
   <caching-scheme-mapping>
      <cache-mapping>
         <cache-name>hello-config-xml</cache-name>
         <scheme-name>thin-remote</scheme-name>
      </cache-mapping>
   </caching-scheme-mapping></p>
<p><caching-schemes>
       <remote-cache-scheme>
           <scheme-name>thin-remote</scheme-name>
           <service-name>Proxy</service-name>
           <initiator-config>
               <tcp-initiator>
                  <remote-addresses>
                      <socket-address>
                          <address>127.0.0.1</address>
                          <port>20000</port>
                      </socket-address>
                  </remote-addresses>
               </tcp-initiator>
           </initiator-config>
       </remote-cache-scheme>
   </caching-schemes>
</cache-config></p>
<pre><code>
#### Create the Server Side Cache Configuration

Create the file `files/conf/hello-server-config.xml` with the following
content:

</code></pre>

<p><cache-config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns="http://xmlns.oracle.com/coherence/coherence-cache-config"
              xsi:schemaLocation="http://xmlns.oracle.com/coherence/coherence-cache-config coherence-cache-config.xsd">
  <caching-scheme-mapping>
    <cache-mapping>
      <cache-name>hello-config-xml</cache-name>
      <scheme-name>${coherence.profile near}-${coherence.client direct}</scheme-name>
    </cache-mapping>
  </caching-scheme-mapping></p>
<p><caching-schemes>
    <!-- near caching scheme for clustered clients -->
    <near-scheme>
      <scheme-name>near-direct</scheme-name>
      <front-scheme>
        <local-scheme>
          <high-units>{front-limit-entries 10000}</high-units>
        </local-scheme>
      </front-scheme>
      <back-scheme>
        <distributed-scheme>
          <scheme-ref>thin-direct</scheme-ref>
        </distributed-scheme>
      </back-scheme>
    </near-scheme></p>
<pre><code>&lt;!-- near caching scheme for extend clients --&gt;
&lt;near-scheme&gt;
  &lt;scheme-name&gt;near-remote&lt;/scheme-name&gt;
  &lt;scheme-ref&gt;near-direct&lt;/scheme-ref&gt;
  &lt;back-scheme&gt;
    &lt;remote-cache-scheme&gt;
      &lt;scheme-ref&gt;thin-remote&lt;/scheme-ref&gt;
    &lt;/remote-cache-scheme&gt;
  &lt;/back-scheme&gt;
&lt;/near-scheme&gt;

&lt;!-- remote caching scheme for accessing the proxy from extend clients --&gt;
&lt;remote-cache-scheme&gt;
  &lt;scheme-name&gt;thin-remote&lt;/scheme-name&gt;
  &lt;service-name&gt;RemoteCache&lt;/service-name&gt;
  &lt;proxy-service-name&gt;Proxy&lt;/proxy-service-name&gt;
&lt;/remote-cache-scheme&gt;

&lt;!-- partitioned caching scheme for clustered clients --&gt;
&lt;distributed-scheme&gt;
  &lt;scheme-name&gt;thin-direct&lt;/scheme-name&gt;
  &lt;scheme-ref&gt;server&lt;/scheme-ref&gt;
  &lt;local-storage system-property="coherence.distributed.localstorage"&gt;false&lt;/local-storage&gt;
  &lt;autostart&gt;false&lt;/autostart&gt;
&lt;/distributed-scheme&gt;

&lt;!-- partitioned caching scheme for servers --&gt;
&lt;distributed-scheme&gt;
  &lt;scheme-name&gt;server&lt;/scheme-name&gt;
  &lt;service-name&gt;PartitionedCache&lt;/service-name&gt;
  &lt;local-storage system-property="coherence.distributed.localstorage"&gt;true&lt;/local-storage&gt;
  &lt;backing-map-scheme&gt;
    &lt;local-scheme&gt;
      &lt;high-units&gt;{back-limit-bytes 0B}&lt;/high-units&gt;
    &lt;/local-scheme&gt;
  &lt;/backing-map-scheme&gt;
  &lt;autostart&gt;true&lt;/autostart&gt;
&lt;/distributed-scheme&gt;

&lt;!-- proxy scheme that allows extend clients to connect to the cluster over TCP/IP --&gt;
&lt;proxy-scheme&gt;
  &lt;service-name&gt;Proxy&lt;/service-name&gt;
  &lt;acceptor-config&gt;
    &lt;tcp-acceptor&gt;
      &lt;local-address&gt;
        &lt;address system-property="coherence.extend.address"/&gt;
        &lt;port system-property="coherence.extend.port"/&gt;
      &lt;/local-address&gt;
    &lt;/tcp-acceptor&gt;
  &lt;/acceptor-config&gt;
  &lt;load-balancer&gt;client&lt;/load-balancer&gt;
  &lt;autostart&gt;true&lt;/autostart&gt;
&lt;/proxy-scheme&gt;
</code></pre>
<p></caching-schemes>
</cache-config></p>
<pre><code>#### Create a Docker Image for the Sidecar

Package the XML file within the sidecar Docker image:

1. Create a `Dockerfile` next to the Java file with the following contents.

   ```bash
   FROM oraclelinux:7-slim
   RUN mkdir -p /files/conf
   COPY files/conf/hello-server-config.xml files/conf/hello-server-config.xml
   ```
   Note that the XML file is placed in the `files/conf` directory relative to the root of the Docker image. This is the default location where Coherence looks for configuration files that apply to Coherence. You can change the location where Coherence looks for configuration files to add to the classpath.

2. Ensure Docker is running on the current host. If not, refer to [Get Started with Docker](https://docs.docker.com/get-started/).

3. Build and tag a Docker image for `hello-server-config-sidecar`:

    ```bash
    $ docker build -t &quot;hello-server-config-sidecar:1.0.0-SNAPSHOT&quot; .
    ```
    Note that the trailing dot &quot;.&quot; is very significant which means to run the build relative to the current directory.

4. Push your image to the Docker registry which the Kubernetes cluster can access. The [Quick Start](./quickstart.md) guide describes how to make the Kubernetes cluster pull the images using the Docker credentials.

   &gt; **Note:** If you are using a local Kubernetes, you can omit this step, since the Kubernetes pulls from the same Docker server as the one to which the local build command built the image.

5. Install the Helm chart with the sidecar image arguments:

```bash
$ helm --debug install coherence/coherence --name hello-server-config \
     --set userArtifacts.image=hello-server-config-sidecar:1.0.0-SNAPSHOT \
     --set imagePullSecrets=sample-coherence-secret \
     --set store.cacheConfig=hello-server-config.xml
</code></pre>

<blockquote>
<p><strong>Note:</strong> If your XML files are in a different location within the sidecar Docker image, use the <code>--set userArtifacts.configDir=&lt;absolute path within docker image&gt;</code> argument to <code>helm install</code> to configure the correct location.</p>
</blockquote>
<p>In a new terminal window, set up a Kubernetes port forward to expose the Extend port so that your local client can use it.  The instructions for doing this are from the output of the <code>helm install</code> command:</p>
<pre><code class="bash">$ export POD_NAME=$(kubectl get pods --namespace default -l &quot;app=coherence,release=hello-server-config&quot; -o jsonpath=&quot;{.items[0].metadata.name}&quot;)
$ kubectl --namespace default port-forward $POD_NAME 20000:20000
</code></pre>

<p>This prints the following output and blocks the shell:</p>
<pre><code class="bash">Forwarding from 127.0.0.1:20000 -&gt; 20000
Forwarding from [::1]:20000 -&gt; 20000
</code></pre>

<h4 id="run-the-client-program">Run the client program</h4>
<p>In the same directory as the XML and Java source files, run the client:</p>
<pre><code class="bash">$ javac  -cp .:${COHERENCE_HOME}/lib/coherence.jar HelloConfigXml.java
$ java -cp .:${COHERENCE_HOME}/lib/coherence.jar \
       -Dcoherence.distributed.localstorage=false \
       -Dcoherence.cacheconfig=$PWD/hello-client-config.xml -Dcoherence.log.level=1 HelloConfigXml
</code></pre>

<p>The correct <code>coherence.jar</code> must be available at <code>${COHERENCE_HOME}/lib/coherence.jar</code>. An output similar to the following is displayed:</p>
<pre><code class="bash">The value of the key is 1
</code></pre>

<p>Run the program again and it shows that the value has been incremented:</p>
<pre><code class="bash">The value of the key is 2.
</code></pre>

<h2 id="deploy-jar-containing-application-classes-and-configuration-files">Deploy JAR Containing Application Classes and Configuration files</h2>
<p>You can deploy a JAR that contains both application classes and configuration files. The sidecar image contains one or more JAR files, each of which can contain application classes, configuration files, or both. JAR files included in the sidecar image are available on the Coherence classpath and all Java classes in those JAR files are available for Classloading by the entire Coherence cluster. The configuration files must be included in the top level of a JAR file so that it can be referenced by the Coherence Helm chart. An example of the sidecar image layout:</p>
<pre><code class="bash">files/
   lib/
      coherence-operator-hello-server-config-1.0.0-SNAPSHOT.jar
</code></pre>

<p>The file layout in the JAR file must be:</p>
<pre><code class="bash">META-INF/
META-INF/LICENSE
META-INF/beans.xml
META-INF/maven/org.javassist/javassist/pom.xml
META-INF/services/org.glassfish.jersey.server.spi.ContainerProvider
com/foo/demo/model/Price.class
cache-config.xml
pof-config.xml
</code></pre>

<p>In the following example, Coherence is installed with the configuration files <code>cache-config.xml</code> and <code>pof-config.xml</code>, and the JAR file with all the Java classes in the Coherence classpath.</p>
<pre><code>$ helm --debug install coherence/coherence --name hello-server-config \
     --set userArtifacts.image=coherence-operator-hello-server-config:1.0.0-SNAPSHOT \
     --set imagePullSecrets=sample-coherence-secret \
     --set store.cacheConfig=cache-config.xml \
     --set store.pof.config=pof-config.xml
</code></pre>

<h2 id="extract-heap-dump-files-from-a-kubernetes-coherence-pod">Extract Heap Dump Files from a Kubernetes Coherence Pod</h2>
<p>You can use the operator to create log files and JVM heap dump files to debug issues in Coherence applications.</p>
<p>Refer to <a href="https://docs.oracle.com/middleware/12213/coherence/develop-applications/debugging-coherence.htm">Debugging in
Coherence</a> section in <em>Oracle Fusion Middleware Developing Applications with Oracle Coherence</em>.</p>
<p>In this example, a <code>.hprof</code> file is collected for a heap dump:</p>
<ol>
<li>Execute the following command to list the pods of the installed operator and Coherence:</li>
</ol>
<p>```bash
$ kubectl get pods
NAME                                 READY     STATUS    RESTARTS   AGE
coherence-demo-storage-0             1/1       Running   0          45m
coherence-demo-storage-1             1/1       Running   0          44m
coherence-operator-7bc94cfb4-g4kz2   1/1       Running   0          47m</p>
<pre><code>2. Get a shell to the storage node:

  ```bash
$ kubectl exec -it coherence-demo-storage-0 -- /bin/bash
</code></pre>

<ol>
<li>Obtain the process ID (PID) of the Coherence process. Use <code>jps</code> to get the actual PID:</li>
</ol>
<p>```bash
bash-4.2# /usr/java/default/bin/jps
1 DefaultCacheServer
4230 Jps</p>
<pre><code>4. Use the `jcmd` command to extract the heap dump and exit the shell:

  ```bash
bash-4.2# /usr/java/default/bin/jcmd 1 GC.heap_dump /DefaultCache.hprof
bash-4.2# exit
</code></pre>

<ol>
<li>Use <code>kubectl exec</code> to extract the heap dump:</li>
</ol>
<p>```bash
$ (kubectl exec coherence-demo-storage-0 -it -- cat /DefaultCache.hprof ) &gt; DefaultCache.hprof</p>
<pre><code>
You can also extract the heap dump using the following single command which can be used repeatedly:

```bash
$ (kubectl exec coherence-demo-storage-0 -- /bin/bash -c &quot;rm -f /tmp/heap.hprof; /usr/java/default/bin/jcmd 1 GC.heap_dump /tmp/heap.hprof; cat /tmp/heap.hprof &gt; /dev/stderr&quot; ) 2&gt; heap.hprof
</code></pre>

<pre><code class="bash">1:
Heap dump file created
</code></pre>

<p>In this command, the PID of the Coherence is assumed to be <code>1</code>. Also, the heap dump output is redirected to <code>stderr</code> to prevent the unsuppressable output from <code>jcmd</code> from showing up in the heap dump file.</p>
<p>You can also refer to <a href="samples/management/diagnostics/heap-dump">Produce and Extract Heap Dump</a> in Samples.</p>
<h2 id="extract-coherence-log-files-from-kubernetes">Extract Coherence Log Files from Kubernetes</h2>
<p>When you install the operator and Coherence with the log capture feature enabled, all the log messages from each Coherence cluster are captured in Elasticsearch, stored with Fluentd, and analyzed in Kibana.
The common practice is to capture all the log messages from all of the Coherence clusters into a log aggregator than examining individual Coherence cluster node log files for errors.
Refer to <a href="samples/operator/logging/log-capture">Enable Log Capture to View Logs in Kiabana</a> sample for installing the operator and Coherence with log capture enabled.</p>
<p>With log capture feature enabled, all the log messages from every Coherence cluster member are captured including the cluster members that are not running. The persistence of the stored log messages depends on how Fluentd is configured and is beyond the scope of this documentation.  </p>
<p>You can reconstruct the log message of each Coherence cluster member by querying Elasticsearch using <code>curl</code>, and manipulating the result using <a href="https://stedolan.github.io/jq/">jq</a> to produce output equivalent to a regular Coherence log file.</p>
<h3 id="query-elasticsearch">Query Elasticsearch</h3>
<p>To reach the Elasticsearch endpoint using <code>curl</code>, you can use port forwarding in Kubernetes to access the Elasticsearch pod. Use the <code>kubectl port-forward</code> with the Elasticsearch name and the port number (default 9200).</p>
<p>Use the following <code>curl</code> command to capture the log message for each Coherence cluster member:</p>
<pre><code class="bash">curl -s --output coherence-0.json http://ES_HOST:ES_PORT/coherence-cluster-*/_search?size=9999&amp;q=host%3A%22my-20190514-storage-coherence-1%22&amp;sort=@timestamp
</code></pre>

<p>In the command, <code>ES_HOST:ES_PORT</code> is the Elasticsearch pod name and port number in which it can reached. This command extracts the log message from the Coherence cluster member named <code>my-storage-coherence-0</code> and stores in the <code>coherence-0.json</code> file.</p>
<p>Reformat the <code>coherence-0.json</code> file using <code>jq</code>:</p>
<pre><code>jq -j '.[&quot;hits&quot;] | .[&quot;hits&quot;] | .[] | .[&quot;_source&quot;] | .[&quot;@timestamp&quot;],&quot; &quot;, .[&quot;product&quot;],&quot; &lt;&quot;, .[&quot;level&quot;], &quot;&gt; (thread=&quot;, .[&quot;thread&quot;], &quot;, member=&quot;, .[&quot;member&quot;], &quot;):&quot;, .[&quot;log&quot;], &quot;newline&quot;' coherence-0.json | sed -e $'s/newline/\\\n/g' &gt; coherence-0.log
</code></pre>

<h2 id="use-java-management-extensions-jmx-to-inspect-and-manage-coherence">Use Java Management Extensions (JMX) to Inspect and Manage Coherence</h2>
<p>JMX is the standard way to inspect and manage enterprise Java applications. Applications that expose themselves through JMX does not incur runtime performance penalty unless a tool is actively connected to the JMX connection. The <a href="https://docs.oracle.com/javase/tutorial/">Java Tutorials</a> provide <a href="https://docs.oracle.com/javase/tutorial/jmx/index.html">Introduction to JMX</a>. The section <a href="https://docs.oracle.com/middleware/12213/coherence/COHMG/using-jmx-manage-oracle-coherence.htm#COHMG239">JMX with Coherence</a> in <em>Oracle Fusion Middleware Developing Applications with Oracle Coherence</em> describes how to use JMX with Coherence.</p>
<p>The Coherence Helm chart must be installed with additional arguments so that you can use the JMX feature in the operator. This section covers how to install Coherence in a Kubernetes cluster with JMX enabled.</p>
<p>You can refer to <a href="samples/management/jmx#access-jmx-in-the-coherence-cluster-using-jconsole-and-visualvm">Access JMX in the Coherence Cluster Using JConsole and VisualVM</a> in the Samples.</p>
<p>Note that to fully appreciate this use case, deploy an application that uses Coherence and creates some caches.  Such an application can be
installed using the steps detailed in <a href="#deploy-jar-files">Deploy JAR Files</a>.</p>
<p>See the <a href="../quickstart/#install-the-operator">Quick Start</a> guide to install the operator. Install Coherence using Helm chart with the following additional argument for JMX <code>--set store.jmx.enabled=true*</code>:</p>
<pre><code class="bash">$ helm --debug install coherence/coherence --name hello-example \
     --set userArtifacts.image=coherence-demo-app:1.0 \
     --set store.jmx.enabled=true \
     --set imagePullSecrets=sample-coherence-secret
</code></pre>

<p>After the installation completes, you must expose the network port for JMX using the <code>kubectl port-forward</code> command.</p>
<p>The instructions  also include suggestions on how to use JConsole or <a href="https://visualvm.github.io/">VisualVM</a>.  In this guide, VisualVM is used to access and manipulate
Coherence MBeans when running within Kubernetes.</p>
<h3 id="download-the-opendmk_jmxremote_optional_jar-jar">Download the <code>opendmk_jmxremote_optional_jar</code> JAR</h3>
<p>The JMX endpoint does not use RMI, instead it uses JMXMP. This requires an
additional JAR on the classpath of the Java JMX client (VisualVM or
JConsole). This can be downloaded as a Maven dependency:</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.glassfish.external&lt;/groupId&gt;
    &lt;artifactId&gt;opendmk_jmxremote_optional_jar&lt;/artifactId&gt;
    &lt;version&gt;1.0-b01-ea&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>or directly from:</p>
<pre><code>http://central.maven.org/maven2/org/glassfish/external/opendmk_jmxremote_optional_jar/1.0-b01-ea/opendmk_jmxremote_optional_jar-1.0-b01-ea.jar
</code></pre>
<h3 id="run-visualvm-with-the-additional-jar">Run VisualVM with the Additional JAR</h3>
<p>Download and start VisualVM 1.4.2 version to enable connection to Coherence in Kubernetes:</p>
<pre><code class="bash">visualvm --jdkhome ${JAVA_HOME} --cp:a PATH_TO_DOWNLOADED.jar
</code></pre>

<h3 id="manipulate-the-visualvm-ui-to-view-the-coherence-mbeans">Manipulate the VisualVM UI to View the Coherence MBeans</h3>
<ol>
<li>
<p>In the <strong>File</strong> menu, choose <strong>Add JMX Connection</strong>. In the <strong>Connection</strong> field, enter the value that was output by the Helm chart instructions. For example, <code>service:jmx:jmxmp://127.0.0.1:9099</code>. Click <strong>OK</strong>.</p>
</li>
<li>
<p>In the left navigation pane, click <strong>Applications</strong>.  Double click the <strong>service:jmx:jmxmp...</strong> link.</p>
</li>
<li>
<p>Click <strong>MBeans</strong> to open the MBeans browser.</p>
</li>
<li>
<p>In the left tree view, open <strong>Coherence</strong> -&gt; <strong>Cache</strong> -&gt;
  <strong>DistributedCache</strong> and search for the cache created by your application.</p>
</li>
</ol>
<p>You can view the MBeans <a href="https://docs.oracle.com/middleware/12213/coherence/COHMG/oracle-coherence-mbeans-reference.htm#GUID-A443DF50-F151-4E9B-AFC9-DFEDF4B149E7__CHDFJDAC">here</a>.</p>
<p>In particular, <code>HighUnits</code>, which defaults to 0. This can be
  interactively changed in <code>visualvm</code>.</p>
<ol>
<li>Expand the tree view and select <strong>Coherence</strong> -&gt; <strong>Node</strong> and choose one of the nodes.</li>
</ol>
<p>You can view the MBeans <a href="https://docs.oracle.com/middleware/12213/coherence/COHMG/oracle-coherence-mbeans-reference.htm#GUID-0AB8710B-2A1D-432D-AFBF-8E73B8230D51__CHDBIJFA">here</a></p>
<p>In particular, <code>LoggingLevel</code>, which defaults to 5. This can be also be interactively changed.</p>
<p>Note that any changes to MBean attributes done in this way does not persist when the cluster restarts. To make persistent changes, you must modify the Coherence configuration files.</p>
<h2 id="provide-arguments-to-the-jvm-that-runs-coherence">Provide Arguments to the JVM that Runs Coherence</h2>
<p>Any production enterprise Java application must carefully tune the JVM arguments for maximum performance, and Coherence is no exception.  This use case explains how to provide JVM arguments to Coherence running inside Kubernetes.</p>
<p>You can also see <a href="samples/management/jvmarguments">Tune JVM Runtime Settings</a> in the Samples.</p>
<p>Also, refer to the <a href="https://docs.oracle.com/middleware/12213/coherence/administer/performance-tuning.htm#GUID-2A0BC9E6-C3AA-4012-B3D8-EC51963B0CEB">Coherence Performance Tuning
documentation</a> for more information about performance tuning.</p>
<p>There are several values in the
<a href="https://github.com/oracle/coherence-operator/blob/master/operator/src/main/helm/coherence/values.yaml">values.yaml</a>
file of the Coherence Helm chart that provides JVM arguments to the JVM that runs Coherence within Kubernetes. See the source code for the authoritative documentation on these values.  Such values include
the following.</p>
<table>
<thead>
<tr>
<th><code>--set</code> left hand side</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>store.maxHeap</code></td>
<td>Heap size arguments to the JVM. The format should be the same as that used for Java's -Xms and -Xmx JVM options. If not set the JVM defaults are used.</td>
</tr>
<tr>
<td><code>store.jmx.maxHeap</code></td>
<td>Heap size arguments passed to the MBean server JVM.  Same format and meaning as the preceding row.</td>
</tr>
<tr>
<td><code>store.jvmArgs</code></td>
<td>Options passed directly to the JVM running Coherence within Kubernetes</td>
</tr>
<tr>
<td><code>store.javaOpts</code></td>
<td>Miscellaneous JVM options to pass to the Coherence store container</td>
</tr>
</tbody>
</table>
<p>The following invocation installs and starts Coherence with specific
values to be passed to the JVM.</p>
<pre><code class="bash">$ helm --debug install coherence/coherence --name hello-example \
     --set store.maxHeap=&quot;8g&quot; \
     --set store.jvmArgs=&quot;-Xloggc:/tmp/gc-log -server -Xcomp&quot; \
     --set store.javaOpts=&quot;-Dcoherence.log.level=6 -Djava.net.preferIPv4Stack=true&quot; \
     --set userArtifacts.image=hello-example-sidecar:1.0.0-SNAPSHOT \
     --set imagePullSecrets=sample-coherence-secret
</code></pre>

<p>The JVM arguments include the <code>store.</code> arguments specified above,
in addition to many others required by the operator and Coherence.</p>
<pre><code class="bash">-Xloggc:/tmp/gc-log -server -Xcomp -Xms8g -Xmx8g -Dcoherence.log.level=6 -Djava.net.preferIPv4Stack=true
</code></pre>

<p>To inspect the full JVM arguments, you can use <code>kubectl get logs -f &lt;pod-name&gt;</code> and search for one of the arguments you specified.</p>
<h1 id="kubernetes-specific-tasks">Kubernetes Specific Tasks</h1>
<h2 id="using-helm-to-scale-the-coherence-deployment">Using Helm to Scale the Coherence Deployment</h2>
<p>The Coherence Operator leverages Kubernetes <code>Statefulsets</code> to ensure that the scale up and scale down operations allow the underlying Coherence cluster nodes sufficient time to rebalance the cluster data.</p>
<p>You can refer to <a href="samples/operator/scaling#scaling-a-coherence-deployment">Scaling a Coherence Deployment</a> in the Samples.</p>
<p>Use the following command to scale up the number of Coherence cluster nodes:</p>
<pre><code class="bash">$ kubectl scale statefulsets &lt;helm_release_name&gt; --replicas=&lt;number_of_nodes&gt;

</code></pre>

<p>For example, to increase the number of Coherence cluster nodes from 2 to 4 for a Coherence Operator installed using Helm chart and the Helm release named <code>coherence_deploy</code>:</p>
<pre><code class="bash">$ kubectl scale statefulsets coherence-deploy --replicas=4
</code></pre>

<p>You can monitor the progress of the cluster as Kubernetes adjusts to the new configuration. Kubernetes shows the number of pods being adjusted and the status of each pod. The pods state change to <code>Running</code> status. The coherence cluster also completes rebalancing before the increment.</p>
<p>To scale down the number of Coherence cluster nodes:</p>
<pre><code class="bash">$ kubectl scale statefulsets coherence-deploy --replicas=3
</code></pre>

<p>The Coherence cluster rebalances the decrease in the number of nodes and the number of pods are adjusted accordingly.</p>
<h2 id="perform-a-safe-rolling-upgrade">Perform a Safe Rolling Upgrade</h2>
<p>The sidecar docker image created using the JAR file containing application classes is tagged with a version number. The version number enables safe rolling upgrades. See Helm documentation for more information about safe rolling upgrades. The safe rolling upgrade allow you to instruct Kubernetes to replace the currently deployed version of the application classes with a different one.  Coherence and Kubernetes ensures that this upgrade is done without any data loss or interruption of service.</p>
<p>You can refer to <a href="samples/operator/rolling-upgrade#change-image-version-for-coherence-or-application-container-using-rolling-upgrade">Change Image Version for Coherence or Application Container Using Rolling Upgrade</a> in the Samples.</p>
<p>Assuming that you have installed the sidecar docker image using the steps detailed in the <a href="./#deploy-jar-files">Deploy JAR Files</a> section and the new sidecar docker image is available for the upgrade, you can use the following command to upgrade:</p>
<pre><code class="bash">$ helm --debug upgrade coherence/coherence --name hello-example --reuse-values \
     --set userArtifacts.image=hello-example-sidecar:1.0.1 --wait \
     --set imagePullSecrets=sample-coherence-secret
</code></pre>

<p>In this example, the <code>hello-example-sidecar:1.0.1</code> is the upgrade destination tagged image. The operator upgrades the application from <code>hello-example-sidecar:1.0.0-SNAPSHOT</code> to
<code>hello-example-sidecar:1.0.1</code>.</p>
<h2 id="deploy-multiple-coherence-clusters">Deploy Multiple Coherence Clusters</h2>
<p>The operator is designed to be installed once on a given
Kubernetes cluster. <a href="https://helm.sh/docs/glossary/#release">Helm release</a> of the Coherence Operator can monitor and manage all of the Coherence clusters installed in the given Kubernetes cluster.</p>
<p>The following commands install the Coherence operator, then install multiple independent Coherence clusters on the same Kubernetes cluster. All the clusters are managed by one operator.</p>
<p>You can refer to <a href="samples/coherence-deployments/multiple-clusters#installing-multiple-coherence-clusters-with-one-operator">nstalling Multiple Coherence Clusters with One Operator</a> in the samples.</p>
<p>First, install the Coherence Operator with an empty list for the <code>targetNamespaces</code> parameter. This causes the operator to manage
all namespaces for Coherence clusters.</p>
<pre><code class="bash">$ helm --debug install coherence/coherence-operator \
    --name sample-coherence-operator \
    --set &quot;targetNamespaces={}&quot; \
    --set imagePullSecrets=sample-coherence-secret
</code></pre>

<p>Then, install two independent clusters which differ in the values
passed to the <code>cluster</code> and <code>userArtifacts.image</code> parameters, and
<code>--name</code> option.</p>
<pre><code class="bash">$ helm --debug install coherence/coherence \
     --set cluster=revenue-management \
     --set imagePullSecrets=sample-coherence-secret \
     --set userArtifacts.image=revenue-app:2.0.1 \
     --name revenue-management

$ helm --debug install coherence/coherence \
     --set cluster=charging \
     --set imagePullSecrets=sample-coherence-secret \
     --set userArtifacts.image=charging-app:2.0.1 \
     --name charging
</code></pre>

<p>The values must be unique to ensure that the two Coherence clusters to not merge and form one cluster.</p>
<blockquote>
<p><strong>Note</strong>: Use the command <code>helm inspect readme &lt;chart name&gt;</code> to print the <code>README.md</code> of the chart. For example <code>helm inspect readme coherence/coherence-operator</code> prints the <code>README.md</code> for the operator chart. This includes documentation on all the possible values that can be configured with <code>--set</code> options to <code>helm</code>.</p>
</blockquote>
<h1 id="monitoring-performance-and-logging">Monitoring Performance and Logging</h1>
<p>See the following guides for monitoring services and viewing logs:</p>
<ul>
<li><a href="../prometheusoperator/">Monitoring Coherence services via Grafana dashboards</a></li>
<li><a href="../logcapture/">Accessing the EFK stack for viewing logs</a></li>
</ul>
<blockquote>
<p><strong>Note</strong>: Use of Prometheus and Grafana is available only when using the operator with Oracle Coherence 12.2.1.4.0.</p>
</blockquote>
<h2 id="configuring-ssl-endpoints-for-management-over-rest-and-metrics-publishing">Configuring SSL Endpoints for Management over REST and Metrics Publishing</h2>
<p>This section describes how to configure SSL for management over REST and Prometheus metrics:
* Configurating SSL Endpoints for Management over REST
* Configuring SSL for Metrics Publishing for Prometheus</p>
<blockquote>
<p><strong>Note:</strong> SSL and Management over REST and metrics publishing are available in Oracle Coherence 12.2.1.4.</p>
</blockquote>
<h2 id="configuring-ssl-endpoints-for-management-over-rest">Configuring SSL Endpoints for Management over REST</h2>
<p>This section describes how to configure a two way SSL for Coherence management over REST with an example:</p>
<ol>
<li>Create Kubernetes secrets for your key store and trust store files. Coherence SSL requires Java key store and trust store files. These files are password protected. Let's define the password protected key store and trust store files:</li>
</ol>
<p><code>bash
    keyStore - name of the Java keystore file: myKeystore.jks
    keyStorePasswordFile - name of the keystore password file: storepassword.txt
    keyPasswordFile - name of the key password file: keypassword.txt
    trustStore - name of the Java trust store file: myTruststore.jks
    trustStorePasswordFile - name of the trust store password file: trustpassword.txt</code>
    The following command creates a Kubernetes secret named <code>ssl-secret</code> which contains the Java key store and trust store files:</p>
<pre><code>```bash
kubectl create secret generic ssl-secret \
 --namespace myNamespace \
 --from-file=./myKeystore.jks \
 --from-file=./myTruststore.jks \
 --from-file=./storepassword.txt \
 --from-file=./keypassword.txt \
 --from-file=./trustpassword.txt
```
</code></pre>
<ol>
<li>
<p>Create a YAML file, <code>helm-values-ssl-management.yaml</code>, to enable SSL for Coherence management over REST using the keystore, trust store, and password files in the <code>ssl-secret</code>:</p>
<p>```yaml   <br />
   store:
     management:
       ssl:
         enabled: true
         secrets: ssl-secret
         keyStore: myKeystore.jks
         keyStorePasswordFile: storepassword.txt
         keyPasswordFile: keypassword.txt
         keyStoreType: JKS
         trustStore: myTruststore.jks
         trustStorePasswordFile: trustpassword.txt
         trustStoreType: JKS
         requireClientCert: true</p>
<pre><code> readinessProbe:
   initialDelaySeconds: 10
</code></pre>
<p><code>``
3. Install the Coherence Helm chart using the YAML file</code>helm-values-ssl-management.yaml`:</p>
</li>
</ol>
<p><code>bash
  helm install coherence/coherence \
    --name coherence \
    --namespace myNamespace \
    --set imagePullSecrets=my-imagePull-secret \
    -f helm-values-ssl-management.yaml</code>
To verify that the Coherence management over REST is running with HTTPS, forward the management listen port to your local machine: and</p>
<p><code>bash
  $ kubectl port-forward &lt;pod name&gt; 30000:30000</code>
Access the REST endpoint using the URL <code>https://localhost:30000/management/coherence/cluster</code>.</p>
<p>SSL certificates are required to access sites using the HTTPS protocol. If you have self-signed certificate, you will get the message that your connection is not secure from the browser. Click <strong>Advanced</strong> and then <strong>Add Exception...</strong> to allow the request to access the URL.</p>
<p>Also, look for the following message in the log file of the Coherence pod: <br />
  <code>Started: HttpAcceptor{Name=Proxy:ManagementHttpProxy:HttpAcceptor, State=(SERVICE_STARTED), HttpServer=NettyHttpServer{Protocol=HTTPS, AuthMethod=cert}</code></p>
<h2 id="configuring-ssl-for-metrics-publishing-for-prometheus">Configuring SSL for Metrics Publishing for Prometheus</h2>
<p>To configure a SSL endpoint for Coherence metrics:</p>
<ol>
<li>
<p>Create Kubernetes secrets for your key store and trust store files. Coherence SSL requires Java key store and trust store files. These files are password protected. Let's define the password protected key store and trust store files:
    <code>bash
    keyStore - name of the Java keystore file: myKeystore.jks
    keyStorePasswordFile - name of the keystore password file: storepassword.txt
    keyPasswordFile - name of the key password file: keypassword.txt
    trustStore - name of the Java trust store file: myTruststore.jks
    trustStorePasswordFile - name of the trust store password file: trustpassword.txt</code></p>
<p>The following command creates a Kubernetes secret named <code>ssl-secret</code> which contains the Java key store and trust store files:</p>
<p><code>bash
kubectl create secret generic ssl-secret \
   --namespace myNamespace \
   --from-file=./myKeystore.jks \
   --from-file=./myTruststore.jks \
   --from-file=./storepassword.txt \
   --from-file=./keypassword.txt \
   --from-file=./trustpassword.txt</code>
2. Create a YAML file, <code>helm-values-ssl-metrics.yaml</code>, using the keystore, trust store, and password file stored in <code>ssl-secret</code>:</p>
<p><code>yaml   
 store:
   metrics:
     ssl:
       enabled: true
       secrets: ssl-secret
       keyStore: myKeystore.jks
       keyStorePasswordFile: storepassword.txt
       keyPasswordFile: keypassword.txt
       keyStoreType: JKS
       trustStore: myTruststore.jks
       trustStorePasswordFile: trustpassword.txt
       trustStoreType: JKS
       requireClientCert: true
       readinessProbe:
       initialDelaySeconds: 10</code>      <br />
3. Install the Coherence helm chart using the YAML file, <code>helm-values-ssl-metrics.yaml</code>:</p>
<p><code>bash
helm install coherence/coherence \
--name coherence \
--namespace myNamespace \
--set imagePullSecrets=my-imagePull-secret \
-f helm-values-ssl-metrics.yaml</code>
To verify that the Coherence metrics for Prometheus is running with HTTPS, forward the Coherence metrics port and access the metrics from your local machine use the following commands:</p>
</li>
</ol>
<p>```bash
  $ kubectl port-forward <Coherence pod> 9612:9612</p>
<p>$ curl -X GET https://localhost:9612/metrics --cacert <caCert> --cert <certificate>
  <code>``
  You can add</code>--insecure<code>if you use self-signed certificate. Also, look for the following message in the log file of the Coherence pod:&lt;/br&gt;</code>Started: HttpAcceptor{Name=Proxy:MetricsHttpProxy:HttpAcceptor, State=(SERVICE_STARTED), HttpServer=NettyHttpServer{Protocol=HTTPS, AuthMethod=cert}`</p>
<p>To configure Prometheus SSL (TLS) connections with the Coherence metrics SSL endpoints, see https://github.com/helm/charts/blob/master/stable/prometheus-operator/README.md for more information about how to specify Kubernetes secrets that contain the certificates required for two-way SSL in Prometheus.
To configure Prometheus to use SSL (TLS) connections, see https://prometheus.io/docs/prometheus/latest/configuration/configuration/#tls_config.</p>
<p>After configuring Prometheus to use SSL, verify that the Prometheus is scraping Coherence metrics over HTTPS by forwarding the Prometheus service port to your local machine and access the following URL:</p>
<pre><code class="bash">  $ kubectl port-forward &lt;Prometheus pod&gt; 9090:9090

  http://localhost:9090/graph
  ```
You should see many vendor:coherence_* metrics.   

To enable SSL for both management over REST and metrics publishing for Prometheus, install the Coherence chart with both YAML files:

  ```bash
    helm --debug install coherence/coherence \
      --name coherence \
      --namespace myNamespace \
      --set imagePullSecrets=my-imagePull-secret \
      -f helm-values-ssl-management.yaml,helm-values-ssl-metrics.yaml
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../samples/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../samples/" class="btn btn-xs btn-link">
        Samples
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../quickstart/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../quickstart/" class="btn btn-xs btn-link">
        Quick Start
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>